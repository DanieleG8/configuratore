<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuratore Prodotto</title>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        #loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            flex-direction: column;
            background: #f5f5f5;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0078D4;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #loading-text {
            margin-top: 20px;
            color: #666;
            font-size: 16px;
        }
        
        #configurator-frame {
            width: 100%;
            height: 100vh;
            border: none;
            display: none;
        }
        
        #error {
            display: none;
            padding: 40px;
            text-align: center;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <p id="loading-text">Caricamento configuratore...</p>
    </div>
    
    <iframe id="configurator-frame"></iframe>
    
    <div id="error">
        <h3>‚ùå Errore</h3>
        <p id="error-message"></p>
    </div>

    <script>
        console.log("üî∑ Widget iniziato");
        
        let quoteId = null;
        let isInitialized = false;
        
        function updateLoading(text) {
            const loadingText = document.getElementById('loading-text');
            if (loadingText) {
                loadingText.textContent = text;
            }
            console.log("üìù " + text);
        }
        
        function showError(message) {
            console.error("‚ùå " + message);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }
        
        if (typeof ZOHO === 'undefined') {
            showError('ZOHO SDK non caricato. Verifica la connessione.');
            throw new Error('ZOHO SDK non disponibile');
        }
        
        console.log("‚úÖ ZOHO SDK caricato");
        updateLoading("Inizializzazione Zoho SDK...");
        
        ZOHO.embeddedApp.on("PageLoad", function(data) {
            console.log("üéâ PageLoad evento ricevuto:", data);
            
            if (isInitialized) {
                console.log("‚ö†Ô∏è Gi√† inizializzato");
                return;
            }
            
            isInitialized = true;
            initWidget(data);
        });
        
        console.log("üöÄ Chiamata init()");
        ZOHO.embeddedApp.init();
        
        setTimeout(function() {
            if (!isInitialized) {
                showError("Timeout: il widget non si √® inizializzato. Ricarica la pagina.");
            }
        }, 10000);
        
        async function initWidget(data) {
            try {
                updateLoading("Recupero dati offerta...");
                
                if (!data.EntityId || !data.EntityId[0]) {
                    throw new Error("ID offerta non trovato");
                }
                
                quoteId = data.EntityId[0];
                console.log("üìã Quote ID:", quoteId);
                
                updateLoading("Generazione token...");
                
                const token = "CRM" + quoteId;
                console.log("üîë Token:", token);
                
                try {
                    updateLoading("Salvataggio token...");
                    await ZOHO.CRM.API.updateRecord({
                        Entity: "Quotes",
                        APIData: {
                            "id": quoteId,
                            "Configurator_Token__c": token,
                            "Last_Config_Action__c": new Date().toISOString()
                        },
                        Trigger: ["workflow"]
                    });
                    console.log("üíæ Token salvato");
                } catch (updateError) {
                    console.warn("‚ö†Ô∏è Errore salvataggio token:", updateError);
                }
                
                updateLoading("Caricamento configuratore...");
                
                const configuratorUrl = `https://panta.orizzontiweb.it/ricerca-prodotti?token=${quoteId}&source=agente`;
                console.log("üåê URL:", configuratorUrl);
                
                const iframe = document.getElementById('configurator-frame');
                
                iframe.addEventListener('load', function() {
                    console.log("‚úÖ Iframe caricato");
                    document.getElementById('loading').style.display = 'none';
                    iframe.style.display = 'block';
                });
                
                iframe.addEventListener('error', function(e) {
                    console.error("‚ùå Errore iframe:", e);
                    showError("Impossibile caricare il configuratore");
                });
                
                iframe.src = configuratorUrl;
                
                setTimeout(function() {
                    if (document.getElementById('loading').style.display !== 'none') {
                        console.log("‚úÖ Iframe caricato (fallback)");
                        document.getElementById('loading').style.display = 'none';
                        iframe.style.display = 'block';
                    }
                }, 3000);
                
            } catch (error) {
                console.error("‚ùå Errore:", error);
                showError("Errore: " + error.message);
            }
        }
    </script>
</body>
</html>
