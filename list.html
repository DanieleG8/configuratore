<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurazioni Esistenti</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
            margin-top: 0;
            font-size: 24px;
        }
        
        .config-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .config-code {
            font-weight: bold;
            color: #0078d4;
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .config-details {
            font-size: 14px;
            color: #666;
            margin: 10px 0;
        }
        
        .edit-button {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .edit-button:hover {
            background: #218838;
        }
        
        .no-config {
            color: #666;
            font-style: italic;
            padding: 40px;
            text-align: center;
            background: white;
            border-radius: 8px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1 id="title">üìã Configurazioni in Offerta</h1>
    <div id="config-list" class="loading">‚è≥ Caricamento...</div>

    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <script>
        let ZOHO_INITIALIZED = false;
        let QUOTE_ID = null;
        let TOKEN = null;
        
        // Inizializza Zoho
        ZOHO.embeddedApp.on("PageLoad", function(data) {
            console.log("Widget caricato", data);
            ZOHO_INITIALIZED = true;
            QUOTE_ID = data.EntityId;
            
            // Carica dati offerta
            loadConfigurations();
        });
        
        ZOHO.embeddedApp.init();
        
        // Carica configurazioni
        function loadConfigurations() {
            ZOHO.CRM.API.getRecord({
                Entity: "Quotes",
                RecordID: QUOTE_ID
            }).then(function(response) {
                console.log("Dati offerta:", response);
                
                if (response.data && response.data.length > 0) {
                    const quote = response.data[0];
                    TOKEN = quote.Token_Configuratore || QUOTE_ID;
                    
                    // Aggiorna titolo
                    document.getElementById('title').textContent = 
                        'üìã Configurazioni in Offerta: ' + (quote.Subject || 'Offerta');
                    
                    // Mostra configurazioni
                    displayConfigurations(quote);
                }
            }).catch(function(error) {
                console.error("Errore:", error);
                showError("Errore nel caricamento delle configurazioni");
            });
        }
        
        // Mostra configurazioni
        function displayConfigurations(quote) {
            const configList = document.getElementById('config-list');
            const productDetails = quote.Product_Details || [];
            
            if (productDetails.length === 0) {
                configList.innerHTML = '<div class="no-config">Nessuna configurazione presente nell\'offerta</div>';
                return;
            }
            
            // Estrai configurazioni uniche
            const configurazioni = {};
            
            productDetails.forEach(item => {
                const codice = item.Codice_Configurazione;
                if (codice) {
                    if (!configurazioni[codice]) {
                        configurazioni[codice] = {
                            codice: codice,
                            righe: 0,
                            prodotti: []
                        };
                    }
                    configurazioni[codice].righe++;
                    
                    const prodotto = item.product_description || item.Product_Name || 'Prodotto';
                    configurazioni[codice].prodotti.push(prodotto);
                }
            });
            
            // Verifica se ci sono configurazioni
            if (Object.keys(configurazioni).length === 0) {
                configList.innerHTML = '<div class="no-config">Nessuna configurazione presente nell\'offerta</div>';
                return;
            }
            
            // Genera HTML
            let html = '';
            for (const codice in configurazioni) {
                const config = configurazioni[codice];
                const primiProdotti = config.prodotti.slice(0, 2).join(', ');
                const altriProdotti = config.prodotti.length > 2 ? 
                    ` +${config.prodotti.length - 2} altri` : '';
                
                html += `
                    <div class="config-item">
                        <div class="config-code">${codice}</div>
                        <div class="config-details">
                            ${config.righe} righe: ${primiProdotti}${altriProdotti}
                        </div>
                        <button class="edit-button" onclick="apriModifica('${codice}')">
                            ‚úèÔ∏è Modifica Configurazione
                        </button>
                    </div>
                `;
            }
            
            configList.innerHTML = html;
        }
        
        // Apri modifica
        function apriModifica(codice) {
            const url = `https://danieleg8.github.io/configuratore/edit.html?code=${encodeURIComponent(codice)}&token=${TOKEN}&quote=${QUOTE_ID}`;
            
            ZOHO.CRM.UI.Popup.open({
                url: url,
                type: 'iframe',
                width: 900,
                height: 600
            });
        }
        
        // Mostra errore
        function showError(message) {
            const configList = document.getElementById('config-list');
            configList.innerHTML = `<div class="no-config" style="color: #dc3545;">${message}</div>`;
        }
    </script>
</body>
</html>
