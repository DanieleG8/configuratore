<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifica Prodotto</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #configuratore-frame {
            width: 100vw;
            height: 100vh;
            border: none;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: Arial, sans-serif;
            color: #666;
        }
        
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: Arial, sans-serif;
            color: #dc3545;
            background: #f8d7da;
            padding: 20px;
            border-radius: 8px;
            display: none;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div id="loading">⏳ Caricamento configuratore...</div>
    <div id="error"></div>
    <iframe id="configuratore-frame"></iframe>

    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <script>
        let ZOHO_INITIALIZED = false;
        let QUOTE_ID = null;
        let CONFIG_CODE = null;
        let PRODUCT_CODE = null;
        
        // Inizializza Zoho
        ZOHO.embeddedApp.on("PageLoad", function(data) {
            console.log("Widget caricato", data);
            ZOHO_INITIALIZED = true;
            QUOTE_ID = data.EntityId;
            
            // Carica dati e trova riga da modificare
            loadQuoteAndOpenConfigurator();
        });
        
        ZOHO.embeddedApp.init();
        
        // Carica offerta e trova riga con flag Modifica=true
        function loadQuoteAndOpenConfigurator() {
            ZOHO.CRM.API.getRecord({
                Entity: "Quotes",
                RecordID: QUOTE_ID
            }).then(function(response) {
                console.log("Dati offerta:", response);
                
                if (response.data && response.data.length > 0) {
                    const quote = response.data[0];
                    const productDetails = quote.Product_Details || [];
                    
                    // Trova riga con Modifica=true
                    const rigaDaModificare = productDetails.find(item => item.Modifica === true);
                    
                    if (!rigaDaModificare) {
                        showError("Nessuna riga selezionata per la modifica. Seleziona una riga e riprova.");
                        return;
                    }
                    
                    PRODUCT_CODE = rigaDaModificare.Cod_Art_Forn;
                    CONFIG_CODE = rigaDaModificare.Codice_Configurazione;
                    
                    if (!PRODUCT_CODE) {
                        showError("Codice articolo mancante sulla riga selezionata");
                        return;
                    }
                    
                    // Apri configuratore
                    apriConfiguratore();
                }
            }).catch(function(error) {
                console.error("Errore:", error);
                showError("Errore nel caricamento dell'offerta");
            });
        }
        
        // Apri configuratore in modalità modifica
        function apriConfiguratore() {
            document.getElementById('loading').style.display = 'block';
            
            const iframe = document.getElementById('configuratore-frame');
            const url = `https://panta.orizzontiweb.it/product-configurator/${encodeURIComponent(PRODUCT_CODE)}?token=CRM${QUOTE_ID}&source=agente`;
            
            console.log("Apertura configuratore:", url);
            iframe.src = url;
            
            // Nascondi loading dopo 2 secondi
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 2000);
        }
        
        // Ascolta messaggi dal configuratore
        window.addEventListener("message", function(event) {
            // Verifica origine
            if (event.origin !== "https://panta.orizzontiweb.it") {
                console.warn("Messaggio da origine non autorizzata:", event.origin);
                return;
            }
            
            console.log("Messaggio ricevuto:", event.data);
            
            // Verifica presenza codice configurazione
            if (event.data && event.data["code-configuration"]) {
                const codiceConfig = event.data["code-configuration"];
                console.log("Codice configurazione ricevuto:", codiceConfig);
                
                // Aggiorna Zoho
                aggiornaOffertaZoho(codiceConfig);
            }
        });
        
        // Aggiorna offerta in Zoho
        function aggiornaOffertaZoho(codiceConfig) {
            if (!ZOHO_INITIALIZED) {
                console.error("Zoho non inizializzato");
                return;
            }
            
            console.log("Aggiornamento offerta Zoho con codice:", codiceConfig);
            
            const updateData = {
                "Codice_Config_da_Importare": codiceConfig,
                "Ultima_Azione_Config": codiceConfig
            };
            
            ZOHO.CRM.API.updateRecord({
                Entity: "Quotes",
                APIData: updateData,
                RecordID: QUOTE_ID
            }).then(function(response) {
                console.log("Offerta aggiornata:", response);
                
                // Chiudi widget
                ZOHO.CRM.UI.Popup.close().then(function() {
                    console.log("Popup chiuso");
                });
            }).catch(function(error) {
                console.error("Errore aggiornamento offerta:", error);
                showError("Errore nell'aggiornamento dell'offerta");
            });
        }
        
        // Mostra errore
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>
