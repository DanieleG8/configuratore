<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuratore Prodotto</title>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        
        .icon {
            font-size: 64px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .btn {
            background: #0078D4;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .btn:hover {
            background: #005a9e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,120,212,0.3);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.success {
            background: #28a745;
        }
        
        .btn.success:hover {
            background: #218838;
        }
        
        .info {
            margin-top: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #0078D4;
            border-radius: 4px;
            font-size: 14px;
            color: #666;
            text-align: left;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
            animation: slideIn 0.3s ease;
            font-weight: 500;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        .loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0078D4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .quote-id {
            font-size: 12px;
            color: #999;
            margin-top: 20px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">üé®</div>
        <h2>Configuratore Prodotto</h2>
        <p>Apri il configuratore per selezionare e personalizzare i tuoi prodotti.</p>
        
        <button id="btn-open" class="btn" disabled>
            <span>Caricamento...</span>
            <span class="loader"></span>
        </button>
        
        <button id="btn-check" class="btn success" style="display:none;">
            üîÑ Verifica Importazione
        </button>
        
        <div class="info">
            <strong>‚ÑπÔ∏è Come funziona:</strong><br>
            1Ô∏è‚É£ Clicca "Apri Configuratore"<br>
            2Ô∏è‚É£ Si aprir√† una nuova finestra<br>
            3Ô∏è‚É£ Configura i tuoi prodotti<br>
            4Ô∏è‚É£ I dati verranno importati automaticamente
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="quote-id" id="quote-info"></div>
    </div>

    <script>
        console.log("üî∑ Widget POPUP iniziato");
        
        let quoteId = null;
        let configuratorWindow = null;
        let checkInterval = null;
        let lastCheck = null;

        ZOHO.embeddedApp.on("PageLoad", function(data) {
            console.log("üéâ PageLoad evento ricevuto:", data);
            
            // Estrai l'intero Quote ID
            if (data.EntityId) {
                if (Array.isArray(data.EntityId)) {
                    quoteId = data.EntityId[0];
                } else {
                    quoteId = data.EntityId;
                }
            }
            
            if (!quoteId) {
                showStatus('error', '‚ùå Impossibile ottenere ID offerta');
                return;
            }
            
            console.log("üìã Quote ID completo:", quoteId);
            
            // Mostra info offerta
            document.getElementById('quote-info').textContent = `Offerta ID: ${quoteId}`;
            
            // Abilita pulsante
            const btnOpen = document.getElementById('btn-open');
            btnOpen.disabled = false;
            btnOpen.innerHTML = 'üöÄ Apri Configuratore';
        });

        ZOHO.embeddedApp.init();

        // Click apertura configuratore
        document.getElementById('btn-open').addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            
            try {
                showStatus('info', '‚è≥ Preparazione configuratore in corso...');
                
                const token = "CRM" + quoteId;
                console.log("üîë Token generato:", token);
                
                // Salva token nell'offerta
                try {
                    await ZOHO.CRM.API.updateRecord({
                        Entity: "Quotes",
                        APIData: {
                            "id": quoteId,
                            "Configurator_Token__c": token,
                            "Last_Config_Action__c": new Date().toISOString()
                        },
                        Trigger: ["workflow"]
                    });
                    console.log("üíæ Token salvato in Zoho CRM");
                } catch (updateError) {
                    console.warn("‚ö†Ô∏è Errore salvataggio token:", updateError);
                }
                
                // Costruisci URL configuratore
                const url = `https://panta.orizzontiweb.it/ricerca-prodotti?token=${quoteId}&source=agente`;
                console.log("üåê Apertura URL in POPUP:", url);
                
                // Apri in POPUP (nuova finestra)
                configuratorWindow = window.open(
                    url, 
                    'Configuratore_Panta',
                    'width=1400,height=900,toolbar=no,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes'
                );
                
                if (!configuratorWindow || configuratorWindow.closed || typeof configuratorWindow.closed == 'undefined') {
                    throw new Error('‚ö†Ô∏è Popup bloccato dal browser. Abilita i popup per questo sito nelle impostazioni del browser.');
                }
                
                showStatus('success', '‚úÖ Configuratore aperto in nuova finestra! Completa la configurazione, poi clicca "Verifica Importazione".');
                
                // Mostra pulsante verifica
                document.getElementById('btn-check').style.display = 'block';
                
                // Avvia controllo automatico
                startAutoCheck();
                
                btn.innerHTML = '‚úÖ Configuratore Aperto';
                
            } catch (error) {
                console.error("‚ùå Errore:", error);
                showStatus('error', `‚ùå ${error.message}`);
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Apri Configuratore';
            }
        });

        // Click verifica manuale
        document.getElementById('btn-check').addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ Verifica in corso...';
            btn.disabled = true;
            
            await checkImport(true);
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 1000);
        });

        // Funzione verifica importazione
        async function checkImport(manual = false) {
            try {
                const record = await ZOHO.CRM.API.getRecord({
                    Entity: "Quotes",
                    RecordID: quoteId
                });

                const lastImport = record.data[0].Last_Config_Import__c;
                
                console.log("üîç Verifica import:", {lastImport, lastCheck});
                
                // Se c'√® un nuovo import
                if (lastImport && lastImport !== lastCheck) {
                    console.log("‚úÖ Nuovo import rilevato!");
                    
                    lastCheck = lastImport;
                    
                    showStatus('success', 'üéâ Configurazione importata con successo! Chiusura automatica...');
                    
                    stopAutoCheck();
                    
                    // Chiudi widget e ricarica offerta
                    setTimeout(() => {
                        ZOHO.CRM.UI.Popup.close().then(() => {
                            ZOHO.CRM.UI.Record.reload();
                        });
                    }, 2000);
                    
                } else if (manual) {
                    showStatus('info', '‚è≥ Nessuna nuova importazione rilevata. Assicurati di aver completato e confermato la configurazione.');
                }
                
            } catch (error) {
                console.error("‚ùå Errore verifica:", error);
                if (manual) {
                    showStatus('error', `‚ùå Errore durante la verifica: ${error.message}`);
                }
            }
        }

        // Controllo automatico ogni 5 secondi
        function startAutoCheck() {
            console.log("üîÑ Avvio controllo automatico (ogni 5 secondi)");
            checkInterval = setInterval(() => {
                console.log("üîÑ Controllo automatico...");
                checkImport(false);
            }, 5000);
        }

        function stopAutoCheck() {
            if (checkInterval) {
                console.log("‚èπÔ∏è Stop controllo automatico");
                clearInterval(checkInterval);
                checkInterval = null;
            }
        }

        // Mostra messaggio status
        function showStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        // Cleanup quando si chiude il widget
        window.addEventListener('beforeunload', () => {
            stopAutoCheck();
        });
    </script>
</body>
</html>
