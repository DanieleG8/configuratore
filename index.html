<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuratore Prodotto</title>
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        #loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            flex-direction: column;
            background: #f5f5f5;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0078D4;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #loading-text {
            margin-top: 20px;
            color: #666;
            font-size: 16px;
        }
        
        #configurator-frame {
            width: 100%;
            height: 100vh;
            border: none;
            display: none;
        }
        
        #error {
            display: none;
            padding: 40px;
            text-align: center;
            color: #d32f2f;
        }
        
        #success {
            display: none;
            padding: 40px;
            text-align: center;
            color: #28a745;
            background: #d4edda;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <p id="loading-text">Caricamento configuratore...</p>
    </div>
    
    <iframe id="configurator-frame"></iframe>
    
    <div id="success">
        <h2>‚úÖ Configurazione Completata!</h2>
        <p id="success-message"></p>
        <p>Importazione dati in corso...</p>
    </div>
    
    <div id="error">
        <h3>‚ùå Errore</h3>
        <p id="error-message"></p>
    </div>

    <script>
        console.log("üî∑ Widget Zoho con postMessage iniziato");
        
        let quoteId = null;
        let isProcessing = false;
        
        function updateLoading(text) {
            const loadingText = document.getElementById('loading-text');
            if (loadingText) {
                loadingText.textContent = text;
            }
            console.log("üìù " + text);
        }
        
        function showError(message) {
            console.error("‚ùå " + message);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('configurator-frame').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }
        
        function showSuccess(configCode) {
            console.log("‚úÖ Configurazione completata:", configCode);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('configurator-frame').style.display = 'none';
            document.getElementById('success').style.display = 'block';
            document.getElementById('success-message').textContent = 
                `Codice configurazione: ${configCode}`;
        }
        
        // ========================================
        // LISTENER PER MESSAGGI DAL CONFIGURATORE
        // ========================================
        window.addEventListener("message", async function(event) {
            
            // ‚ö†Ô∏è IMPORTANTE: Verifica origine (sostituisci con dominio reale)
            // In produzione usa: if (event.origin !== "https://panta.orizzontiweb.it") return;
            console.log("üì® Messaggio ricevuto da:", event.origin);
            console.log("üì¶ Dati messaggio:", event.data);
            
            // Controlla se √® il messaggio che ci interessa
            if (!event.data || !event.data.tipo) {
                console.log("‚ö†Ô∏è Messaggio senza tipo, ignorato");
                return;
            }
            
            // Se √® il messaggio di configurazione completata
            if (event.data.tipo === "configurazioneCompletata" || 
                event.data.tipo === "domChange" ||
                event.data.tipo === "carrelloAggiornato") {
                
                if (isProcessing) {
                    console.log("‚ö†Ô∏è Gi√† in elaborazione, skip");
                    return;
                }
                
                isProcessing = true;
                
                try {
                    // Estrai codice configurazione dal messaggio
                    let configCode = null;
                    
                    // Alessandro invia: {"code-configuration": "chiave_configurazione"}
                    if (event.data["code-configuration"]) {
                        configCode = event.data["code-configuration"];
                    } else if (event.data.configCode) {
                        configCode = event.data.configCode;
                    } else if (event.data.data && event.data.data.configCode) {
                        configCode = event.data.data.configCode;
                    }
                    
                    if (!configCode) {
                        console.error("‚ùå Codice configurazione non trovato nel messaggio");
                        return;
                    }
                    
                    console.log("üîë Codice configurazione ricevuto:", configCode);
                    
                    showSuccess(configCode);
                    
                    // Aggiorna Zoho con codice configurazione
                    console.log("üíæ Aggiornamento Zoho CRM...");
                    
                    await ZOHO.CRM.API.updateRecord({
                        Entity: "Quotes",
                        APIData: {
                            "id": quoteId,
                            "Pending_Config_Code__c": configCode,
                            "Last_Config_Import__c": new Date().toISOString()
                        },
                        Trigger: ["workflow"]
                    });
                    
                    console.log("‚úÖ Zoho aggiornato, il workflow importer√† i dati");
                    
                    // Chiudi widget dopo 3 secondi
                    setTimeout(() => {
                        ZOHO.CRM.UI.Popup.close().then(() => {
                            ZOHO.CRM.UI.Record.reload();
                        });
                    }, 3000);
                    
                } catch (error) {
                    console.error("‚ùå Errore elaborazione messaggio:", error);
                    showError("Errore durante il salvataggio: " + error.message);
                    isProcessing = false;
                }
            }
        });
        
        // ========================================
        // INIZIALIZZAZIONE ZOHO
        // ========================================
        if (typeof ZOHO === 'undefined') {
            showError('ZOHO SDK non caricato. Verifica la connessione.');
            throw new Error('ZOHO SDK non disponibile');
        }
        
        console.log("‚úÖ ZOHO SDK caricato");
        updateLoading("Inizializzazione Zoho SDK...");
        
        ZOHO.embeddedApp.on("PageLoad", function(data) {
            console.log("üéâ PageLoad evento ricevuto:", data);
            
            // Estrai Quote ID
            if (data.EntityId) {
                if (Array.isArray(data.EntityId)) {
                    quoteId = data.EntityId[0];
                } else {
                    quoteId = data.EntityId;
                }
            }
            
            if (!quoteId) {
                showError("Impossibile ottenere ID offerta");
                return;
            }
            
            console.log("üìã Quote ID:", quoteId);
            
            initWidget();
        });
        
        console.log("üöÄ Chiamata init()");
        ZOHO.embeddedApp.init();
        
        setTimeout(function() {
            if (!quoteId) {
                showError("Timeout: il widget non si √® inizializzato. Ricarica la pagina.");
            }
        }, 10000);
        
        // ========================================
        // CARICAMENTO CONFIGURATORE IN IFRAME
        // ========================================
        async function initWidget() {
            try {
                updateLoading("Generazione token...");
                
                const token = "CRM" + quoteId;
                console.log("üîë Token:", token);
                
                try {
                    await ZOHO.CRM.API.updateRecord({
                        Entity: "Quotes",
                        APIData: {
                            "id": quoteId,
                            "Configurator_Token__c": token,
                            "Last_Config_Action__c": new Date().toISOString()
                        },
                        Trigger: ["workflow"]
                    });
                    console.log("üíæ Token salvato");
                } catch (updateError) {
                    console.warn("‚ö†Ô∏è Errore salvataggio token:", updateError);
                }
                
                updateLoading("Caricamento configuratore...");
                
                // URL con parametro source=zoho per identificare la provenienza
                const configuratorUrl = `https://panta.orizzontiweb.it/ricerca-prodotti?token=${quoteId}&source=zoho`;
                console.log("üåê URL:", configuratorUrl);
                
                const iframe = document.getElementById('configurator-frame');
                
                iframe.addEventListener('load', function() {
                    console.log("‚úÖ Iframe caricato");
                    document.getElementById('loading').style.display = 'none';
                    iframe.style.display = 'block';
                });
                
                iframe.src = configuratorUrl;
                
                setTimeout(function() {
                    if (document.getElementById('loading').style.display !== 'none') {
                        console.log("‚úÖ Iframe caricato (fallback)");
                        document.getElementById('loading').style.display = 'none';
                        iframe.style.display = 'block';
                    }
                }, 3000);
                
            } catch (error) {
                console.error("‚ùå Errore:", error);
                showError("Errore: " + error.message);
            }
        }
    </script>
</body>
</html>
