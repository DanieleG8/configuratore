<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifica Prodotto</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        
        #configuratore-frame {
            width: 100%;
            height: calc(100vh - 40px);
            border: none;
            display: none;
        }
        
        #debug {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        #loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        #error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .riga-debug {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 3px solid #ccc;
        }
        
        .riga-debug.selected {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        pre {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="debug">
        <h2>üîç Debug Info</h2>
        <div id="debug-content" class="loading">‚è≥ Caricamento dati...</div>
    </div>
    
    <div id="error" style="display: none;"></div>
    <iframe id="configuratore-frame"></iframe>

    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <script>
        let ZOHO_INITIALIZED = false;
        let QUOTE_ID = null;
        let CONFIG_CODE = null;
        let PRODUCT_CODE = null;
        
        // Inizializza Zoho
        ZOHO.embeddedApp.on("PageLoad", function(data) {
            console.log("Widget caricato", data);
            ZOHO_INITIALIZED = true;
            QUOTE_ID = data.EntityId;
            
            // Carica dati e mostra debug
            loadQuoteAndDebug();
        });
        
        ZOHO.embeddedApp.init();
        
        // Carica offerta e mostra debug
        function loadQuoteAndDebug() {
            ZOHO.CRM.API.getRecord({
                Entity: "Quotes",
                RecordID: QUOTE_ID
            }).then(function(response) {
                console.log("Dati offerta:", response);
                
                if (response.data && response.data.length > 0) {
                    const quote = response.data[0];
                    const productDetails = quote.Product_Details || [];
                    
                    // Mostra debug
                    showDebugInfo(productDetails);
                    
                    // Trova riga con Modifica=true
                    const rigaDaModificare = findRigaModifica(productDetails);
                    
                    if (!rigaDaModificare) {
                        showError("‚ùå Nessuna riga selezionata per la modifica. Seleziona una riga e riprova.");
                        return;
                    }
                    
                    PRODUCT_CODE = rigaDaModificare.Cod_Art_Forn;
                    CONFIG_CODE = rigaDaModificare.Codice_Configurazione;
                    
                    if (!PRODUCT_CODE) {
                        showError("‚ùå Codice articolo mancante sulla riga selezionata");
                        return;
                    }
                    
                    // Nascondi debug e apri configuratore
                    document.getElementById('debug').style.display = 'none';
                    apriConfiguratore();
                }
            }).catch(function(error) {
                console.error("Errore:", error);
                showError("Errore nel caricamento dell'offerta: " + error);
            });
        }
        
        // Mostra info debug
        function showDebugInfo(productDetails) {
            const debugContent = document.getElementById('debug-content');
            
            if (productDetails.length === 0) {
                debugContent.innerHTML = '<p>Nessuna riga trovata nell\'offerta</p>';
                return;
            }
            
            let html = '<h3>Righe trovate: ' + productDetails.length + '</h3>';
            
            productDetails.forEach((item, index) => {
                const hasModifica = hasKey(item, 'Modifica');
                const modificaValue = item.Modifica;
                const modificaType = typeof modificaValue;
                const isSelected = checkModificaValue(modificaValue);
                
                const cssClass = isSelected ? 'riga-debug selected' : 'riga-debug';
                
                html += '<div class="' + cssClass + '">';
                html += '<strong>Riga ' + (index + 1) + '</strong><br>';
                html += 'Prodotto: ' + (item.product_description || item.Product_Name || 'N/A') + '<br>';
                html += 'Cod_Art_Forn: ' + (item.Cod_Art_Forn || 'N/A') + '<br>';
                html += 'Campo "Modifica" presente: ' + (hasModifica ? 'S√å' : 'NO') + '<br>';
                html += 'Valore "Modifica": ' + JSON.stringify(modificaValue) + '<br>';
                html += 'Tipo dato: ' + modificaType + '<br>';
                html += 'Valutato come TRUE: ' + (isSelected ? 'S√å ‚úÖ' : 'NO') + '<br>';
                html += '<details><summary>JSON completo</summary><pre>' + JSON.stringify(item, null, 2) + '</pre></details>';
                html += '</div>';
            });
            
            debugContent.innerHTML = html;
        }
        
        // Verifica se campo esiste
        function hasKey(obj, key) {
            return obj.hasOwnProperty(key) || obj.hasOwnProperty(key.toLowerCase()) || obj.hasOwnProperty(key.toUpperCase());
        }
        
        // Trova riga con Modifica=true (con tutti i possibili formati)
        function findRigaModifica(productDetails) {
            return productDetails.find(item => checkModificaValue(item.Modifica));
        }
        
        // Controlla se il valore di Modifica √® "true"
        function checkModificaValue(value) {
            if (value === true || value === 'true' || value === 1 || value === '1') {
                return true;
            }
            return false;
        }
        
        // Apri configuratore in modalit√† modifica
        function apriConfiguratore() {
            document.getElementById('configuratore-frame').style.display = 'block';
            
            const iframe = document.getElementById('configuratore-frame');
            const url = `https://panta.orizzontiweb.it/product-configurator/${encodeURIComponent(PRODUCT_CODE)}?token=CRM${QUOTE_ID}&source=agente`;
            
            console.log("Apertura configuratore:", url);
            iframe.src = url;
        }
        
        // Ascolta messaggi dal configuratore
        window.addEventListener("message", function(event) {
            // Verifica origine
            if (event.origin !== "https://panta.orizzontiweb.it") {
                console.warn("Messaggio da origine non autorizzata:", event.origin);
                return;
            }
            
            console.log("Messaggio ricevuto:", event.data);
            
            // Verifica presenza codice configurazione
            if (event.data && event.data["code-configuration"]) {
                const codiceConfig = event.data["code-configuration"];
                console.log("Codice configurazione ricevuto:", codiceConfig);
                
                // Aggiorna Zoho
                aggiornaOffertaZoho(codiceConfig);
            }
        });
        
        // Aggiorna offerta in Zoho
        function aggiornaOffertaZoho(codiceConfig) {
            if (!ZOHO_INITIALIZED) {
                console.error("Zoho non inizializzato");
                return;
            }
            
            console.log("Aggiornamento offerta Zoho con codice:", codiceConfig);
            
            const updateData = {
                "Codice_Config_da_Importare": codiceConfig,
                "Ultima_Azione_Config": codiceConfig
            };
            
            ZOHO.CRM.API.updateRecord({
                Entity: "Quotes",
                APIData: updateData,
                RecordID: QUOTE_ID
            }).then(function(response) {
                console.log("Offerta aggiornata:", response);
                
                // Chiudi widget
                ZOHO.CRM.UI.Popup.close().then(function() {
                    console.log("Popup chiuso");
                });
            }).catch(function(error) {
                console.error("Errore aggiornamento offerta:", error);
                showError("Errore nell'aggiornamento dell'offerta: " + error);
            });
        }
        
        // Mostra errore
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>
