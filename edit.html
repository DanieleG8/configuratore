<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifica Prodotto - Debug</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        
        #debug {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        #error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .riga-debug {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 3px solid #ccc;
        }
        
        .riga-debug.selected {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        pre {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        button:hover {
            background: #005a9e;
        }
    </style>
</head>
<body>
    <div id="debug">
        <h2>üîç Debug Mode - Analisi Righe</h2>
        <div id="debug-content" class="loading">‚è≥ Caricamento dati offerta...</div>
    </div>
    
    <div id="error" style="display: none;"></div>
    
    <div id="actions" style="display: none;">
        <button onclick="procediComunque()">Procedi con prima riga</button>
        <button onclick="window.close()">Chiudi</button>
    </div>

    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <script>
        let ZOHO_INITIALIZED = false;
        let QUOTE_ID = null;
        let QUOTE_DATA = null;
        
        // Inizializza Zoho
        ZOHO.embeddedApp.on("PageLoad", function(data) {
            console.log("‚úÖ Widget caricato", data);
            ZOHO_INITIALIZED = true;
            QUOTE_ID = data.EntityId;
            
            document.getElementById('debug-content').innerHTML = 
                '<p>‚úÖ Zoho inizializzato<br>Entity: ' + data.Entity + '<br>Quote ID: ' + QUOTE_ID + '</p>';
            
            // Carica dati
            loadQuoteData();
        });
        
        ZOHO.embeddedApp.init();
        
        // Carica dati offerta
        function loadQuoteData() {
            document.getElementById('debug-content').innerHTML += '<p>üì° Chiamata API in corso...</p>';
            
            ZOHO.CRM.API.getRecord({
                Entity: "Quotes",
                RecordID: QUOTE_ID
            }).then(function(response) {
                console.log("‚úÖ Risposta API:", response);
                
                document.getElementById('debug-content').innerHTML += '<p>‚úÖ API risposta ricevuta</p>';
                
                if (!response.data || response.data.length === 0) {
                    showError("‚ùå Nessun dato nell'offerta");
                    document.getElementById('debug-content').innerHTML += '<pre>' + JSON.stringify(response, null, 2) + '</pre>';
                    return;
                }
                
                const quote = response.data[0];
                QUOTE_DATA = quote;
                
                // Mostra debug completo
                showFullDebug(quote);
                
            }).catch(function(error) {
                console.error("‚ùå Errore API:", error);
                showError("Errore caricamento: " + JSON.stringify(error));
                document.getElementById('debug-content').innerHTML += '<pre>' + JSON.stringify(error, null, 2) + '</pre>';
            });
        }
        
        // Mostra debug completo
        function showFullDebug(quote) {
            let html = '<h3>üìã Dati Offerta</h3>';
            html += '<p><strong>Subject:</strong> ' + (quote.Subject || 'N/A') + '</p>';
            html += '<p><strong>Quote Number:</strong> ' + (quote.Quote_Number || 'N/A') + '</p>';
            
            // Product_Details
            const productDetails = quote.Product_Details;
            
            html += '<hr><h3>üì¶ Product_Details</h3>';
            
            if (!productDetails) {
                html += '<p style="color: red;">‚ùå Campo "Product_Details" non presente!</p>';
                html += '<p>Campi disponibili nell\'offerta:</p>';
                html += '<pre>' + Object.keys(quote).join('\n') + '</pre>';
                document.getElementById('debug-content').innerHTML = html;
                showError("Campo Product_Details non trovato");
                return;
            }
            
            if (!Array.isArray(productDetails)) {
                html += '<p style="color: red;">‚ùå Product_Details non √® un array!</p>';
                html += '<pre>Tipo: ' + typeof productDetails + '\nValore: ' + JSON.stringify(productDetails, null, 2) + '</pre>';
                document.getElementById('debug-content').innerHTML = html;
                showError("Product_Details formato non valido");
                return;
            }
            
            if (productDetails.length === 0) {
                html += '<p style="color: orange;">‚ö†Ô∏è Nessuna riga presente nell\'offerta</p>';
                document.getElementById('debug-content').innerHTML = html;
                showError("Offerta vuota - nessuna riga da modificare");
                return;
            }
            
            html += '<p><strong>Numero righe:</strong> ' + productDetails.length + '</p>';
            html += '<hr>';
            
            // Analizza ogni riga
            let rigaTrovata = false;
            productDetails.forEach((item, index) => {
                const modificaValue = item.Modifica;
                const isSelected = checkModificaValue(modificaValue);
                
                if (isSelected) rigaTrovata = true;
                
                const cssClass = isSelected ? 'riga-debug selected' : 'riga-debug';
                
                html += '<div class="' + cssClass + '">';
                html += '<h4>Riga #' + (index + 1) + (isSelected ? ' ‚úÖ SELEZIONATA' : '') + '</h4>';
                
                // Info principali
                html += '<p><strong>Prodotto:</strong> ' + (item.product_description || 'N/A') + '</p>';
                html += '<p><strong>Cod_Art_Forn:</strong> ' + (item.Cod_Art_Forn || 'N/A') + '</p>';
                html += '<p><strong>Codice_Configurazione:</strong> ' + (item.Codice_Configurazione || 'N/A') + '</p>';
                
                // Campo Modifica
                html += '<hr style="margin: 10px 0;">';
                html += '<p><strong>Campo "Modifica":</strong></p>';
                html += '<ul style="margin: 5px 0; padding-left: 20px;">';
                html += '<li>Presente: ' + (item.hasOwnProperty('Modifica') ? 'S√å' : 'NO') + '</li>';
                html += '<li>Valore: <code>' + JSON.stringify(modificaValue) + '</code></li>';
                html += '<li>Tipo: <code>' + typeof modificaValue + '</code></li>';
                html += '<li>Valutato come TRUE: ' + (isSelected ? 'S√å ‚úÖ' : 'NO ‚ùå') + '</li>';
                html += '</ul>';
                
                // JSON completo (collassabile)
                html += '<details><summary>üîç JSON completo</summary><pre>' + JSON.stringify(item, null, 2) + '</pre></details>';
                html += '</div>';
            });
            
            html += '<hr><h3>üìä Riepilogo</h3>';
            html += '<p><strong>Righe con Modifica=true:</strong> ' + (rigaTrovata ? 'S√å ‚úÖ' : 'NO ‚ùå') + '</p>';
            
            document.getElementById('debug-content').innerHTML = html;
            
            if (!rigaTrovata) {
                showError("‚ùå Nessuna riga ha il flag Modifica=true. Seleziona una riga nell'offerta e riprova.");
                document.getElementById('actions').style.display = 'block';
            }
        }
        
        // Controlla valore Modifica
        function checkModificaValue(value) {
            // Controlla tutti i possibili formati
            if (value === true) return true;
            if (value === 'true') return true;
            if (value === 1) return true;
            if (value === '1') return true;
            if (value === 'True') return true;
            if (value === 'TRUE') return true;
            return false;
        }
        
        // Mostra errore
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.innerHTML = '<strong>‚ö†Ô∏è Attenzione:</strong><br>' + message;
            errorDiv.style.display = 'block';
        }
        
        // Procedi comunque con prima riga
        function procediComunque() {
            if (!QUOTE_DATA || !QUOTE_DATA.Product_Details || QUOTE_DATA.Product_Details.length === 0) {
                alert("Nessuna riga disponibile");
                return;
            }
            
            const primaRiga = QUOTE_DATA.Product_Details[0];
            const codArt = primaRiga.Cod_Art_Forn;
            
            if (!codArt) {
                alert("Prima riga non ha Cod_Art_Forn");
                return;
            }
            
            const url = `https://panta.orizzontiweb.it/product-configurator/${encodeURIComponent(codArt)}?token=CRM${QUOTE_ID}&source=agente`;
            window.open(url, '_blank');
        }
    </script>
</body>
</html>
